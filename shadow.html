<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Building with Solar PV Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }
        .controls button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .controls button:hover {
            background-color: #2980b9;
            transform: scale(1.1);
        }
        .controls button:active {
            background-color: #1f5f8a;
            transform: scale(1);
        }
        .output {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            text-align: left;
        }
        .output p {
            margin: 5px 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="simulateAndSetLighting('morning')">Morning</button>
        <button onclick="simulateAndSetLighting('afternoon')">Afternoon</button>
        <button onclick="simulateAndSetLighting('evening')">Evening</button>
        <button onclick="simulateAndSetLighting('night')">Night</button>
    </div>

    <div class="output">
        <p id="angleOfIncidence"></p>
        <p id="solarRadiation"></p>
        <p id="powerGenerated"></p>
        <p id="dailyEnergy"></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        let scene, camera, renderer, building, sunLight, controls;

        function init() {
            // Scene setup
            scene = new THREE.Scene();

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(10, 10, 20);

            // Renderer setup
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // Smooth movement
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;
            controls.minZoom = 0.5; // Limit zoom-out
            controls.maxZoom = 2;   // Limit zoom-in

            // Create building model
            const buildingGroup = new THREE.Group();

            // Main building structure with more color
            const mainBuildingGeometry = new THREE.BoxGeometry(4, 20, 4);
            const mainBuildingMaterial = new THREE.MeshStandardMaterial({ color: 0xff5733 }); // Bright color for realism
            const mainBuilding = new THREE.Mesh(mainBuildingGeometry, mainBuildingMaterial);
            mainBuilding.castShadow = true;
            buildingGroup.add(mainBuilding);

            // Infrastructure additions (e.g., antennas, windows)
            const antennaGeometry = new THREE.CylinderGeometry(0.1, 0.1, 2, 32);
            const antennaMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const antenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
            antenna.position.set(0, 5, 0);
            buildingGroup.add(antenna);

            // Example windows
            const windowGeometry = new THREE.BoxGeometry(1, 0.5, 0.1);
            const windowMaterial = new THREE.MeshStandardMaterial({ color: 0x00BFFF });
            for (let i = -1.5; i <= 1.5; i += 1.5) {
                const window1 = new THREE.Mesh(windowGeometry, windowMaterial);
                window1.position.set(i, 2, 2.05);
                buildingGroup.add(window1);
                
                const window2 = new THREE.Mesh(windowGeometry, windowMaterial);
                window2.position.set(i, 2, -2.05);
                buildingGroup.add(window2);
            }

            // Adding the building group to the scene
            scene.add(buildingGroup);

            // White ground plane
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff } ); // White color
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Sunlight
            sunLight = new THREE.DirectionalLight(0xffa500, 1);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);

            // Initial Lighting
            setLighting('morning');

            // Event listeners for interaction
            window.addEventListener('resize', onWindowResize, false);

            // Render loop
            animate();
        }

        function simulateAndSetLighting(timeOfDay) {
            setLighting(timeOfDay);
            simulate(timeOfDay);
        }

        function setLighting(timeOfDay) {
            let lightPosition;
            switch (timeOfDay) {
                case 'morning':
                    lightPosition = { x: -10, y: 5, z: 5};
                    break;
                case 'afternoon':
                    lightPosition = { x: 10, y: 30, z: -5 };
                    break;
                case 'evening':
                    lightPosition = { x: 5, y: 10, z: -10 };
                    break;
                case 'night':
                    lightPosition = { x: -5, y: 52, z: 10 };
                    sunLight.intensity = 0.2;
                    break;
                default:
                    lightPosition = { x: -10, y: 10, z: 5 };
            }

            sunLight.position.set(lightPosition.x, lightPosition.y, lightPosition.z);
            if (timeOfDay !== 'night') sunLight.intensity = 2;
        }

        function simulate(timeOfDay) {
            // Constants (example values, you can adjust these based on real data)
            let alpha = 0.5; // Example solar elevation angle
            let phi = 1.0;   // Example azimuth angle
            let beta = 0.2;  // Example tilt angle
            let GHI = 1000;  // Example Global Horizontal Irradiance in W/m^2
            let A_BIPV = 10; // Area in m^2
            let eta = 0.15;  // Efficiency (15% in this case)
            let sunlightHours = 6; // Example sunlight hours

            // Example time of day modifiers (these are arbitrary for simulation purposes)
            let modifiers = {
                'morning': 0.7,
                'afternoon': 1.0,
                'evening': 0.5,
                'night': 0.0
            };

            let modifier = modifiers[timeOfDay];

            // Calculate the angle of incidence (θ)
            let cosTheta = Math.sin(alpha) * Math.sin(phi) * Math.sin(beta) + Math.cos(alpha) * Math.cos(phi) * Math.cos(beta);
            let theta = Math.acos(cosTheta);

            // Calculate solar radiation incident on a vertical surface (I_vert)
            let I_vert = GHI * cosTheta * modifier;

            // Calculate power generated by PV system (P_PV)
            let P_PV = I_vert * A_BIPV * eta;

            // Calculate daily energy generation (E_daily)
            let E_daily = P_PV * sunlightHours;

            // Display the results
            document.getElementById('angleOfIncidence').innerText = `Angle of Incidence (θ): ${theta.toFixed(2)} radians`;
            document.getElementById('solarRadiation').innerText = `Solar Radiation Incident (I_vert): ${I_vert.toFixed(2)} W/m^2`;
            document.getElementById('powerGenerated').innerText = `Power Generated (P_PV): ${P_PV.toFixed(2)} W`;
            document.getElementById('dailyEnergy').innerText = `Daily Energy Generation (E_daily): ${E_daily.toFixed(2)} Wh`;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
